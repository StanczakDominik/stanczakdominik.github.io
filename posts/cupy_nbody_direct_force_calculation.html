<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2019-03-04">

<title>CuPy speedup of naive N-Body vectorized force calculation – Dominik Stańczak-Marikin’s blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Dominik Stańczak-Marikin’s blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../bookshelf.html"> 
<span class="menu-text">Bookshelf</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/StanczakDominik/stanczakdominik.github.io"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text">GitHub</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text">RSS</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">CuPy speedup of naive N-Body vectorized force calculation</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">cupy</div>
                <div class="quarto-category">nbody</div>
                <div class="quarto-category">gpu</div>
                <div class="quarto-category">python</div>
                <div class="quarto-category">N-body simulation</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 4, 2019</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>I had intended to write a post about speeding up our <a href="../posts/parallelizable-numpy-implementation-of-2d-ising-model">Numpy Ising implementation</a>, which we <a href="../posts/quantitative-data-analysis-of-the-2d-ising-model">found out gave reasonable numerical values</a>, though the small grids we were able to use limited the accuracy a fair bit. However, a few difficulties came up, so I thought instead (to keep writing these a habit!) I would write a little bit about using CuPy to speed up force calculations in N-body simulations. This might be a point I’ll come back to later on this blog, as I have an ongoing project implementing that.</p>
<!-- TEASER_END -->
<p>The part of the n-body simulation we’ll look at is the calculation of forces, where the force on the i-th point particle or celestial object is:</p>
<p><span class="math display">\[ F_i = \sum_j F_{ij} = G \sum_j \frac{m_i m_j}{|\vec{r_i}-\vec{r_j}|^3 } (\vec{r_i}-\vec{r_j}) \]</span></p>
<p>From this, Newton’s law gives <span class="math inline">\(\vec{a_i} = \vec{F_i} / m_i\)</span>. I was trying to use my own implementation of this vectorization, but I found <a href="https://stackoverflow.com/a/52562874/4417567">a neat implementation by PMende on Stack</a> that’s both more general and faster than what I had been doing. Let’s take a look!</p>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cupy</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy_html</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I basically copypasted the following:</p>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> accelerations(positions, masses, G <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">    https://stackoverflow.com/a/52562874</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Params:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - positions: numpy array of size (n,3)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - masses: numpy array of size (n,)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    xp <span class="op">=</span> cupy.get_array_module(positions)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    mass_matrix <span class="op">=</span> masses.reshape((<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))<span class="op">*</span>masses.reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    disps <span class="op">=</span> positions.reshape((<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span>)) <span class="op">-</span> positions.reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>)) <span class="co"># displacements</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    dists <span class="op">=</span> xp.linalg.norm(disps, axis<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    dists[dists <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span> <span class="co"># Avoid divide by zero warnings</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    forces <span class="op">=</span> G<span class="op">*</span>disps<span class="op">*</span>mass_matrix<span class="op">/</span>xp.expand_dims(dists, <span class="dv">2</span>)<span class="op">**</span><span class="dv">3</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> forces.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)<span class="op">/</span>masses.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main change I made was adding this line:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>    xp <span class="op">=</span> cupy.get_array_module(positions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Which returns <code>numpy</code> if we pass in a <code>numpy.ndarray</code> and <code>cupy</code> if we pass in a CuPy array. This will make this function more generic for our purposes.</p>
<p>Let’s take a look at what each of those lines does. For the illustrations, we’ll take some particularly simple values:</p>
<div id="cell-6" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> numpy.arange(N) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> (numpy.arange(N<span class="op">*</span><span class="dv">3</span>)<span class="op">**</span><span class="dv">2</span>).reshape((N, <span class="dv">3</span>))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="0">1</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="1">2</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="2">3</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="3">4</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="4">5</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Pretty printing of arrays, by the way, is provided by the awesome <code>numpy_html</code> package. We can now start digging! Let’s first investigate the <code>mass_matrix</code>:</p>
<div id="cell-8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mass_matrix <span class="op">=</span> m.reshape((<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">*</span> m.reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>mass_matrix.T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0, 0)">1</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 1)">2</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 2)">3</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 3)">4</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 4)">5</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(0, 1, 0)">2</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 1)">4</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 2)">6</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 3)">8</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 4)">10</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 2, 0)">3</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 1)">6</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 2)">9</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 3)">12</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 4)">15</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(0, 3, 0)">4</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 1)">8</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 2)">12</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 3)">16</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 4)">20</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 4, 0)">5</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 1)">10</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 2)">15</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 3)">20</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 4)">25</td>
</tr>
</tbody>
</table></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This was a <code>(5, 5, 1)</code>-shaped array, but I used a <code>.T</code> transposition so that it would print more nicely, as a <code>(1, 5, 5)</code>-shaped array. This shows that the (i, j)-th entry is just <span class="math inline">\(m_i m_j\)</span> - with the shape it has, we should be able to take advantage of Numpy broadcasting in our calculation.</p>
<p>Let’s now look at the displacements - <code>disps</code>. The line is</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>    disps <span class="op">=</span> r.reshape((<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span>)) <span class="op">-</span> r.reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>but let’s break it down a little bit more. <code>r</code> is</p>
<div id="cell-10" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0)">0</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1)">1</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2)">4</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(1, 0)">9</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1)">16</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2)">25</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 0)">36</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1)">49</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2)">64</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(3, 0)">81</td>
<td style="font-family: monospace; white-space: pre" title="(3, 1)">100</td>
<td style="font-family: monospace; white-space: pre" title="(3, 2)">121</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(4, 0)">144</td>
<td style="font-family: monospace; white-space: pre" title="(4, 1)">169</td>
<td style="font-family: monospace; white-space: pre" title="(4, 2)">196</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>while if you reshape it with a single added dimension (signified by <code>1</code>) in the first place:</p>
<div id="cell-12" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>r.reshape((<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0, 0)">0</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 1)">1</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 2)">4</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(0, 1, 0)">9</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 1)">16</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 2)">25</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 2, 0)">36</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 1)">49</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 2)">64</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(0, 3, 0)">81</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 1)">100</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 2)">121</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 4, 0)">144</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 1)">169</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 2)">196</td>
</tr>
</tbody>
</table></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>while if we were to add a dimension in the second slot:</p>
<div id="cell-14" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>r.reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0, 0)">0</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 1)">1</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 2)">4</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="even">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(1, 0, 0)">9</td>
<td style="font-family: monospace; white-space: pre" title="(1, 0, 1)">16</td>
<td style="font-family: monospace; white-space: pre" title="(1, 0, 2)">25</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 0, 0)">36</td>
<td style="font-family: monospace; white-space: pre" title="(2, 0, 1)">49</td>
<td style="font-family: monospace; white-space: pre" title="(2, 0, 2)">64</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="even">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(3, 0, 0)">81</td>
<td style="font-family: monospace; white-space: pre" title="(3, 0, 1)">100</td>
<td style="font-family: monospace; white-space: pre" title="(3, 0, 2)">121</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(4, 0, 0)">144</td>
<td style="font-family: monospace; white-space: pre" title="(4, 0, 1)">169</td>
<td style="font-family: monospace; white-space: pre" title="(4, 0, 2)">196</td>
</tr>
</tbody>
</table></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We thus have a <code>(1, 5, 3)</code>-shaped array and a <code>(5, 1, 3)</code> array. Numpy (and anything implementing Numpy’s broadcasting API by extension) is going to expand that into a <code>(5, 5, 3)</code> array:</p>
<div id="cell-16" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>disps <span class="op">=</span> r.reshape((<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span>)) <span class="op">-</span> r.reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>disps.T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0, 0)">0</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 1)">-9</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 2)">-36</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 3)">-81</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 4)">-144</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(0, 1, 0)">9</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 1)">0</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 2)">-27</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 3)">-72</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 4)">-135</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 2, 0)">36</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 1)">27</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 2)">0</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 3)">-45</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 4)">-108</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(0, 3, 0)">81</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 1)">72</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 2)">45</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 3)">0</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 4)">-63</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 4, 0)">144</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 1)">135</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 2)">108</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 3)">63</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 4)">0</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="even">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(1, 0, 0)">0</td>
<td style="font-family: monospace; white-space: pre" title="(1, 0, 1)">-15</td>
<td style="font-family: monospace; white-space: pre" title="(1, 0, 2)">-48</td>
<td style="font-family: monospace; white-space: pre" title="(1, 0, 3)">-99</td>
<td style="font-family: monospace; white-space: pre" title="(1, 0, 4)">-168</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(1, 1, 0)">15</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1, 1)">0</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1, 2)">-33</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1, 3)">-84</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1, 4)">-153</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(1, 2, 0)">48</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2, 1)">33</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2, 2)">0</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2, 3)">-51</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2, 4)">-120</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(1, 3, 0)">99</td>
<td style="font-family: monospace; white-space: pre" title="(1, 3, 1)">84</td>
<td style="font-family: monospace; white-space: pre" title="(1, 3, 2)">51</td>
<td style="font-family: monospace; white-space: pre" title="(1, 3, 3)">0</td>
<td style="font-family: monospace; white-space: pre" title="(1, 3, 4)">-69</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(1, 4, 0)">168</td>
<td style="font-family: monospace; white-space: pre" title="(1, 4, 1)">153</td>
<td style="font-family: monospace; white-space: pre" title="(1, 4, 2)">120</td>
<td style="font-family: monospace; white-space: pre" title="(1, 4, 3)">69</td>
<td style="font-family: monospace; white-space: pre" title="(1, 4, 4)">0</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 0, 0)">0</td>
<td style="font-family: monospace; white-space: pre" title="(2, 0, 1)">-21</td>
<td style="font-family: monospace; white-space: pre" title="(2, 0, 2)">-60</td>
<td style="font-family: monospace; white-space: pre" title="(2, 0, 3)">-117</td>
<td style="font-family: monospace; white-space: pre" title="(2, 0, 4)">-192</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(2, 1, 0)">21</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1, 1)">0</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1, 2)">-39</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1, 3)">-96</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1, 4)">-171</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 2, 0)">60</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2, 1)">39</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2, 2)">0</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2, 3)">-57</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2, 4)">-132</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(2, 3, 0)">117</td>
<td style="font-family: monospace; white-space: pre" title="(2, 3, 1)">96</td>
<td style="font-family: monospace; white-space: pre" title="(2, 3, 2)">57</td>
<td style="font-family: monospace; white-space: pre" title="(2, 3, 3)">0</td>
<td style="font-family: monospace; white-space: pre" title="(2, 3, 4)">-75</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 4, 0)">192</td>
<td style="font-family: monospace; white-space: pre" title="(2, 4, 1)">171</td>
<td style="font-family: monospace; white-space: pre" title="(2, 4, 2)">132</td>
<td style="font-family: monospace; white-space: pre" title="(2, 4, 3)">75</td>
<td style="font-family: monospace; white-space: pre" title="(2, 4, 4)">0</td>
</tr>
</tbody>
</table></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Which I chose to print with a transpose (as a <code>(3, 5, 5)</code> array) so as to illustrate the structure a bit more. Each of the three <code>(5, 5)</code> arrays displays a different spatial component of <span class="math inline">\(\vec{r_i} - \vec{r_j}\)</span>. The arrays are antisymmetric as <span class="math inline">\(\vec{r_{ij}} = - \vec{r_{ji}}\)</span>.</p>
<p>Let’s continue with the calculations! The next line simply calculates the norms of those inter-particle distances, outputting an <code>(N, N)</code> array (summing over the “spatial dimensions” axis):</p>
<div id="cell-18" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>dists <span class="op">=</span> np.linalg.norm(disps, axis<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>dists</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1)">27.33130074</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2)">84.85281374</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3)">173.35224256</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4)">292.95733478</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(1, 0)">27.33130074</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2)">57.78408085</td>
<td style="font-family: monospace; white-space: pre" title="(1, 3)">146.47866739</td>
<td style="font-family: monospace; white-space: pre" title="(1, 4)">266.22359024</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 0)">84.85281374</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1)">57.78408085</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(2, 3)">88.74119675</td>
<td style="font-family: monospace; white-space: pre" title="(2, 4)">208.53776636</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(3, 0)">173.35224256</td>
<td style="font-family: monospace; white-space: pre" title="(3, 1)">146.47866739</td>
<td style="font-family: monospace; white-space: pre" title="(3, 2)">88.74119675</td>
<td style="font-family: monospace; white-space: pre" title="(3, 3)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(3, 4)">119.81235329</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(4, 0)">292.95733478</td>
<td style="font-family: monospace; white-space: pre" title="(4, 1)">266.22359024</td>
<td style="font-family: monospace; white-space: pre" title="(4, 2)">208.53776636</td>
<td style="font-family: monospace; white-space: pre" title="(4, 3)">119.81235329</td>
<td style="font-family: monospace; white-space: pre" title="(4, 4)">0.</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The next step is pretty clever. Since in <code>disps</code> (see above) each diagonal element is zero (since that’s <span class="math inline">\(\vec{r_{ii}}\)</span>), and we’ll be dividing those by distances, we’re going to have Numpy screaming obscenities at us for dividing by zero. But since <code>0 / 1 = 0</code>, we lose nothing and gain peace of mind by doing:</p>
<div id="cell-20" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dists[dists <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>dists</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0)">1.</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1)">27.33130074</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2)">84.85281374</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3)">173.35224256</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4)">292.95733478</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(1, 0)">27.33130074</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1)">1.</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2)">57.78408085</td>
<td style="font-family: monospace; white-space: pre" title="(1, 3)">146.47866739</td>
<td style="font-family: monospace; white-space: pre" title="(1, 4)">266.22359024</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 0)">84.85281374</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1)">57.78408085</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2)">1.</td>
<td style="font-family: monospace; white-space: pre" title="(2, 3)">88.74119675</td>
<td style="font-family: monospace; white-space: pre" title="(2, 4)">208.53776636</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(3, 0)">173.35224256</td>
<td style="font-family: monospace; white-space: pre" title="(3, 1)">146.47866739</td>
<td style="font-family: monospace; white-space: pre" title="(3, 2)">88.74119675</td>
<td style="font-family: monospace; white-space: pre" title="(3, 3)">1.</td>
<td style="font-family: monospace; white-space: pre" title="(3, 4)">119.81235329</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(4, 0)">292.95733478</td>
<td style="font-family: monospace; white-space: pre" title="(4, 1)">266.22359024</td>
<td style="font-family: monospace; white-space: pre" title="(4, 2)">208.53776636</td>
<td style="font-family: monospace; white-space: pre" title="(4, 3)">119.81235329</td>
<td style="font-family: monospace; white-space: pre" title="(4, 4)">1.</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Simple and effective! In my own implementation I had <code>np.inf</code> instead of <code>1</code> so as to get <code>anything / np.inf == 0</code>, but if <code>anything = 0</code> for the problematic cases, that’s fine as well.</p>
<p>The next line simply adds a dimension:</p>
<div id="cell-22" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dists.shape, np.expand_dims(dists, <span class="dv">2</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>((5, 5), (5, 5, 1))</code></pre>
</div>
</div>
<p>For those curious as to why not just <code>.reshape((-1, -1, 1))</code>:</p>
<div id="cell-24" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    dists.reshape((<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e:</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>can only specify one unknown dimension</code></pre>
</div>
</div>
<p>And now we can finally calculate the forces themselves, first getting each of <span class="math inline">\(\vec{F_{ij}}\)</span>:</p>
<div id="cell-26" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> <span class="dv">1</span>  <span class="co"># because let's be real...</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>forces <span class="op">=</span> G <span class="op">*</span> disps <span class="op">*</span> mass_matrix <span class="op">/</span> np.expand_dims(dists, <span class="dv">2</span>) <span class="op">**</span> <span class="dv">3</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>forces</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0, 0)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 1)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(0, 0, 2)">0.</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(0, 1, 0)">0.00088164</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 1)">0.0014694</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1, 2)">0.00205716</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 2, 0)">0.00017678</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 1)">0.0002357</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2, 2)">0.00029463</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(0, 3, 0)">6.2195164e-05</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 1)">7.60163116e-05</td>
<td style="font-family: monospace; white-space: pre" title="(0, 3, 2)">8.98374591e-05</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 4, 0)">2.86364625e-05</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 1)">3.34092063e-05</td>
<td style="font-family: monospace; white-space: pre" title="(0, 4, 2)">3.81819501e-05</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="even">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(1, 0, 0)">-0.00088164</td>
<td style="font-family: monospace; white-space: pre" title="(1, 0, 1)">-0.0014694</td>
<td style="font-family: monospace; white-space: pre" title="(1, 0, 2)">-0.00205716</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(1, 1, 0)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1, 1)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1, 2)">0.</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(1, 2, 0)">0.00083963</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2, 1)">0.00102622</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2, 2)">0.00121281</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(1, 3, 0)">0.00018327</td>
<td style="font-family: monospace; white-space: pre" title="(1, 3, 1)">0.00021382</td>
<td style="font-family: monospace; white-space: pre" title="(1, 3, 2)">0.00024436</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(1, 4, 0)">7.15474501e-05</td>
<td style="font-family: monospace; white-space: pre" title="(1, 4, 1)">8.10871102e-05</td>
<td style="font-family: monospace; white-space: pre" title="(1, 4, 2)">9.06267702e-05</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 0, 0)">-0.00017678</td>
<td style="font-family: monospace; white-space: pre" title="(2, 0, 1)">-0.0002357</td>
<td style="font-family: monospace; white-space: pre" title="(2, 0, 2)">-0.00029463</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(2, 1, 0)">-0.00083963</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1, 1)">-0.00102622</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1, 2)">-0.00121281</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 2, 0)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2, 1)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2, 2)">0.</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(2, 3, 0)">0.00077271</td>
<td style="font-family: monospace; white-space: pre" title="(2, 3, 1)">0.00087574</td>
<td style="font-family: monospace; white-space: pre" title="(2, 3, 2)">0.00097877</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 4, 0)">0.00017863</td>
<td style="font-family: monospace; white-space: pre" title="(2, 4, 1)">0.00019848</td>
<td style="font-family: monospace; white-space: pre" title="(2, 4, 2)">0.00021833</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="even">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(3, 0, 0)">-6.2195164e-05</td>
<td style="font-family: monospace; white-space: pre" title="(3, 0, 1)">-7.60163116e-05</td>
<td style="font-family: monospace; white-space: pre" title="(3, 0, 2)">-8.98374591e-05</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(3, 1, 0)">-0.00018327</td>
<td style="font-family: monospace; white-space: pre" title="(3, 1, 1)">-0.00021382</td>
<td style="font-family: monospace; white-space: pre" title="(3, 1, 2)">-0.00024436</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(3, 2, 0)">-0.00077271</td>
<td style="font-family: monospace; white-space: pre" title="(3, 2, 1)">-0.00087574</td>
<td style="font-family: monospace; white-space: pre" title="(3, 2, 2)">-0.00097877</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(3, 3, 0)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(3, 3, 1)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(3, 3, 2)">0.</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(3, 4, 0)">0.0007326</td>
<td style="font-family: monospace; white-space: pre" title="(3, 4, 1)">0.00080237</td>
<td style="font-family: monospace; white-space: pre" title="(3, 4, 2)">0.00087214</td>
</tr>
</tbody>
</table></td>
</tr>
<tr class="odd">
<td><table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(4, 0, 0)">-2.86364625e-05</td>
<td style="font-family: monospace; white-space: pre" title="(4, 0, 1)">-3.34092063e-05</td>
<td style="font-family: monospace; white-space: pre" title="(4, 0, 2)">-3.81819501e-05</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(4, 1, 0)">-7.15474501e-05</td>
<td style="font-family: monospace; white-space: pre" title="(4, 1, 1)">-8.10871102e-05</td>
<td style="font-family: monospace; white-space: pre" title="(4, 1, 2)">-9.06267702e-05</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(4, 2, 0)">-0.00017863</td>
<td style="font-family: monospace; white-space: pre" title="(4, 2, 1)">-0.00019848</td>
<td style="font-family: monospace; white-space: pre" title="(4, 2, 2)">-0.00021833</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(4, 3, 0)">-0.0007326</td>
<td style="font-family: monospace; white-space: pre" title="(4, 3, 1)">-0.00080237</td>
<td style="font-family: monospace; white-space: pre" title="(4, 3, 2)">-0.00087214</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(4, 4, 0)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(4, 4, 1)">0.</td>
<td style="font-family: monospace; white-space: pre" title="(4, 4, 2)">0.</td>
</tr>
</tbody>
</table></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>And we can contract that to <span class="math inline">\(\vec{F_i}\)</span> by summing over the other-particle index:</p>
<div id="cell-28" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>forces.<span class="bu">sum</span>(axis <span class="op">=</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0)">0.00114925</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1)">0.00181453</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2)">0.00247981</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(1, 0)">0.00021281</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1)">-0.00014827</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2)">-0.00050936</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 0)">-6.50662895e-05</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1)">-0.0001877</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2)">-0.00031034</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(3, 0)">-0.00028558</td>
<td style="font-family: monospace; white-space: pre" title="(3, 1)">-0.00036321</td>
<td style="font-family: monospace; white-space: pre" title="(3, 2)">-0.00044083</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(4, 0)">-0.00101141</td>
<td style="font-family: monospace; white-space: pre" title="(4, 1)">-0.00111535</td>
<td style="font-family: monospace; white-space: pre" title="(4, 2)">-0.00121928</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>And from here, a simple division by the masses suffices to get the acceleration, but we need to remember to turn the mass into a <code>(N, 1)</code> array via a simple reshape:</p>
<div id="cell-30" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>forces.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)<span class="op">/</span>m.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(0, 0)">0.00114925</td>
<td style="font-family: monospace; white-space: pre" title="(0, 1)">0.00181453</td>
<td style="font-family: monospace; white-space: pre" title="(0, 2)">0.00247981</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(1, 0)">0.00010641</td>
<td style="font-family: monospace; white-space: pre" title="(1, 1)">-7.4137417e-05</td>
<td style="font-family: monospace; white-space: pre" title="(1, 2)">-0.00025468</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(2, 0)">-2.16887632e-05</td>
<td style="font-family: monospace; white-space: pre" title="(2, 1)">-6.25669817e-05</td>
<td style="font-family: monospace; white-space: pre" title="(2, 2)">-0.00010345</td>
</tr>
<tr class="even">
<td style="font-family: monospace; white-space: pre" title="(3, 0)">-7.13957375e-05</td>
<td style="font-family: monospace; white-space: pre" title="(3, 1)">-9.08016861e-05</td>
<td style="font-family: monospace; white-space: pre" title="(3, 2)">-0.00011021</td>
</tr>
<tr class="odd">
<td style="font-family: monospace; white-space: pre" title="(4, 0)">-0.00020228</td>
<td style="font-family: monospace; white-space: pre" title="(4, 1)">-0.00022307</td>
<td style="font-family: monospace; white-space: pre" title="(4, 2)">-0.00024386</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Let’s run a quick test first that also serves to illustrate the results. We’ll first write a simple function that prepares some reasonable parameters - masses and positions in arrays provided by our chosen packages.</p>
<div id="cell-32" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prep(N, np <span class="op">=</span> numpy, seed <span class="op">=</span> <span class="dv">0</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> np.<span class="bu">abs</span>(np.random.normal(loc<span class="op">=</span><span class="dv">100</span>, scale<span class="op">=</span><span class="dv">20</span>, size<span class="op">=</span>N))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> np.random.normal(size<span class="op">=</span>(N, <span class="dv">3</span>))</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r, m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For a test, we’ll set <code>z = 0</code>:</p>
<div id="cell-34" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>r, m <span class="op">=</span> prep(<span class="dv">10</span>, numpy, seed <span class="op">=</span> <span class="dv">17</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>r[:, <span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>ax, ay, az <span class="op">=</span> accelerations(r, m).T</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>x, y, z <span class="op">=</span> r.T</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, m)<span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>plt.quiver(x, y, ax, ay)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="cupy_nbody_direct_force_calculation_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looks just about right! The system is evidently self-gravitating. Let’s do the same for a few more bodies:</p>
<div id="cell-36" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>r, m <span class="op">=</span> prep(<span class="dv">500</span>, numpy, seed <span class="op">=</span> <span class="dv">17</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>r[:, <span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>ax, ay, az <span class="op">=</span> accelerations(r, m).T</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>x, y, z <span class="op">=</span> r.T</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, m)<span class="op">;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>plt.quiver(x, y, ax, ay)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="cupy_nbody_direct_force_calculation_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And that’s a proper mess, but the arrows seem to be oriented the right way (towards the system’s center of mass) and you get a bunch of very long arrows, signifying high forces at short distances - another issue that I might well come back to in another post!</p>
<p>And the nice thing is that our function works just as well on the GPU!</p>
<div id="cell-38" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ax, ay, az <span class="op">=</span> cupy.asnumpy(accelerations(cupy.asarray(r), cupy.asarray(m)).T)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>plt.scatter(x, y, m)<span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>plt.quiver(x, y, ax, ay)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="cupy_nbody_direct_force_calculation_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s now run a quick bechmark:</p>
<div id="cell-40" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>numbers_of_bodies <span class="op">=</span> [<span class="dv">2</span><span class="op">**</span>n <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>, <span class="dv">13</span>)]</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> np <span class="kw">in</span> [numpy, cupy]:</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> N <span class="kw">in</span> numbers_of_bodies:</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        r, m <span class="op">=</span> prep(N, np, seed<span class="op">=</span><span class="dv">17</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        time <span class="op">=</span> <span class="op">%</span>timeit <span class="op">-</span>oq accelerations(r, m)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        results.append({<span class="st">"library"</span>:np.<span class="va">__name__</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"N"</span>: N,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"average"</span>: time.average,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"stdev"</span>: time.stdev})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-41" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pandas.DataFrame(results)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">N</th>
<th data-quarto-table-cell-role="th">average</th>
<th data-quarto-table-cell-role="th">library</th>
<th data-quarto-table-cell-role="th">stdev</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>16</td>
<td>0.000076</td>
<td>numpy</td>
<td>0.000003</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>32</td>
<td>0.000179</td>
<td>numpy</td>
<td>0.000002</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>64</td>
<td>0.000589</td>
<td>numpy</td>
<td>0.000020</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>128</td>
<td>0.002245</td>
<td>numpy</td>
<td>0.000139</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>256</td>
<td>0.012159</td>
<td>numpy</td>
<td>0.003883</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>512</td>
<td>0.044007</td>
<td>numpy</td>
<td>0.004827</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>1024</td>
<td>0.187316</td>
<td>numpy</td>
<td>0.007669</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2048</td>
<td>0.718909</td>
<td>numpy</td>
<td>0.027526</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>4096</td>
<td>2.867943</td>
<td>numpy</td>
<td>0.055799</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>16</td>
<td>0.001288</td>
<td>cupy</td>
<td>0.000021</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>32</td>
<td>0.001316</td>
<td>cupy</td>
<td>0.000030</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>64</td>
<td>0.001463</td>
<td>cupy</td>
<td>0.000146</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>128</td>
<td>0.001430</td>
<td>cupy</td>
<td>0.000112</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>256</td>
<td>0.001321</td>
<td>cupy</td>
<td>0.000024</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>512</td>
<td>0.001656</td>
<td>cupy</td>
<td>0.000022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>1024</td>
<td>0.005480</td>
<td>cupy</td>
<td>0.000082</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>2048</td>
<td>0.020252</td>
<td>cupy</td>
<td>0.000017</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>4096</td>
<td>0.080994</td>
<td>cupy</td>
<td>0.000289</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-42" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Average runtime [s]"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label, g <span class="kw">in</span> df.groupby(<span class="st">'library'</span>):</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    g.plot(<span class="st">'N'</span>, <span class="st">'average'</span>, ax<span class="op">=</span>ax, label<span class="op">=</span>label, logx<span class="op">=</span><span class="va">True</span>, logy<span class="op">=</span><span class="va">True</span>, style<span class="op">=</span><span class="st">"o--"</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>ax.grid()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="cupy_nbody_direct_force_calculation_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Thus at low numbers of particles, CuPy has a performance overhead, but at larger numbers of particles (as limited by <code>MemoryError</code>s on my device, with the regime shifting around 100 particles), the GPU (predictably) wins!</p>
<p>We can also calculate the runtime ratios for a speedup estimate:</p>
<div id="cell-44" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>speedups <span class="op">=</span> df[df.library <span class="op">==</span><span class="st">'numpy'</span>].set_index(<span class="st">'N'</span>).average <span class="op">/</span> df[df.library <span class="op">==</span><span class="st">'cupy'</span>].set_index(<span class="st">'N'</span>).average</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>speedups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>N
16       0.059079
32       0.135752
64       0.402321
128      1.570570
256      9.204320
512     26.570801
1024    34.179128
2048    35.498837
4096    35.409139
Name: average, dtype: float64</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>speedups.plot(logx<span class="op">=</span><span class="va">True</span>, style<span class="op">=</span><span class="st">"o--"</span>, logy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"GPU over CPU speedup"</span>)<span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>plt.grid()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="cupy_nbody_direct_force_calculation_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>While this is obviously not a full proper test (we don’t know how much host-device memory transfer would impact our timings, etc), it’s at least nice to see that we get 35 times the speed on the GPU for the pure acceleration stage basically for free!</p>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/stanczakdominik\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="stanczakdominik/stanczakdominik.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>